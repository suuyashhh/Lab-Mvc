@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "CasePaper Create";
}

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    body {
        background-color: #f5f5f5;
    }

    .headerd {
        background-color: #5f9278;
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .back-button {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
    }

    .headerd h1 {
        font-size: 24px;
        font-weight: normal;
    }

    .container {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 24px;
        position: relative;
    }

        .form-group label {
            display: block;
            color: #333;
            font-size: 16px;
            margin-bottom: 8px;
        }

    .input-field {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #000;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s;
    }

        .input-field:focus {
            border-color: #5f9278;
        }

    .row {
        display: flex;
        gap: 20px;
    }

    .col {
        flex: 1;
    }

    .unit-field {
        background-color: white;
        color: #666;
    }

    textarea.input-field {
        min-height: 120px;
        resize: vertical;
    }

    .section-title {
        font-size: 24px;
        margin: 40px 0 20px;
    }

    .section-subtitle {
        color: #666;
        margin-bottom: 20px;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 40px;
    }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border: 1px solid #000;
            border-radius: 4px;
        }

        .checkbox-group label {
            font-size: 16px;
            color: #333;
        }



    .tests-section {
        max-width: 100%;
        overflow-x: hidden;
    }

    .section-subtitle {
        color: #333;
        margin: 30px 0 20px;
        font-size: 20px;
        font-weight: 500;
    }

    .table-responsive {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid #ddd;
        max-width: 100%;
        width: 100%;
        background-color: #fff;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
        text-align: left;
    }

    th {
        background-color: #5f9278;
        color: white;
    }

    tr:hover {
        background-color: #eee;
    }

    .delete-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

        .delete-btn:hover {
            background-color: #c82333;
        }

    input {
        width: 100%;
        border: 1px solid #ccc;
        padding: 6px;
        font-size: 16px;
        border-radius: 4px;
        outline: none;
    }

    .blood-tests-table {
        width: 100%;
        min-width: 600px;
        border-collapse: collapse;
        background-color: #f5f5f5;
    }

        .blood-tests-table th,
        .blood-tests-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .blood-tests-table th {
            background-color: #5f9278;
            color: white;
            font-weight: bold;
        }

        .blood-tests-table tbody tr:hover {
            background-color: #eee;
        }

   /* .delete-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }

        .delete-btn:hover {
            background-color: #c82333;
        }*/

    .add-test-section {
        margin-top: 20px;
    }

    .test-inputs {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .select-test {
        flex: 1;
    }

    .add-btn {
        background-color: #5f9278;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        white-space: nowrap;
    }

        .add-btn:hover {
            background-color: #4a7259;
        }

    @@media (max-width: 768px) {
        .test-inputs {
            flex-direction: column;
        }

        .add-btn {
            width: 100%;
        }
    }
</style>

<div class="body">
    <div class="pagetitle">
        <h1>Case Paper</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item active">Case Paper</li>
            </ol>
        </nav>
    </div>


    <div class="container">
        <form>
            <div class="form-group">
                <label>Petient Name</label>
                <input type="text" id="PName" class="input-field">
            </div>

            <div class="form-group">
                <label>Date Of Birth</label>
                <input type="text" id="PBOD" class="input-field">
            </div>

            <div class="row">
                <div class="col form-group">
                    <label>Gender</label>
                    <input type="text" id="Gender" class="input-field">
                </div>
                <div class="col form-group">
                    <label>Phone Number</label>
                    <input type="text" id="PNumber" class="input-field unit-field">
                </div>
            </div>

            <div class="form-group">
                <label>Address (Optional)</label>
                <textarea type="text" rows="3" class="input-field"></textarea>
            </div>

            <div class="form-group">
                <label>Doctor Reference</label>
                <input type="text" id="Doctor" class="input-field">
            </div>

            <div class="tests-section">
                <h3 class="section-subtitle" style="color: #333; margin: 30px 0 20px;">Blood Tests</h3>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="blood-tests-table" id="tblMaterials">
                        <thead>
                            <tr>
                                <th>Sr No</th>
                                <th>Test Name</th>
                                <th>Price (₹)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-editable="false">1</td>
                                <td data-editable="true">Complete Blood Count (CBC)</td>
                                <td data-editable="true">500</td>
                                <td>
                                    <button class="delete-btn">Delete</button>
                                </td>
                            </tr>
                            <tr>
                                <td data-editable="false">2</td>
                                <td data-editable="true">Blood Sugar Test</td>
                                <td data-editable="true">300</td>
                                <td>
                                    <button class="delete-btn">Delete</button>
                                </td>
                            </tr>
                        </tbody>
                        <thead>
                            <tr>
                                <th colspan="2">Total Amount</th>
                                <th id="totalPrice">₹0</th>
                                <th></th>
                            </tr>
                        </thead>
                    </table>
                </div>

                <!-- Add Test Section -->
                <div class="add-test-section">
                    <div class="test-inputs">
                        @*<select class="input-field select-test">
            <option value="">Select Test</option>
            <option value="cbc">Complete Blood Count (CBC)</option>
            <option value="sugar">Blood Sugar Test</option>
            <option value="thyroid">Thyroid Profile</option>
            <option value="lipid">Lipid Profile</option>
        </select>*@
                        <input class="input-field select-test" id="TestName" name="TestName" placeholder="Test Name" type="text" autocomplete="off" />                        
                        @*<button class="add-btn" id="btnAdd" href="javascript:void(0);">Add Test</button>*@
                        <a class="add-btn" id="btnAdd" href="javascript:void(0);">Add Test</a>
                    </div>
                </div>
            </div>

            <h2 class="section-title">Discount (%)</h2>
            <p class="section-subtitle">If you gave the discount please fill in the below field</p>

            <div class="form-group">
                <label>Dis (%)</label>
                <input type="text" class="input-field">
            </div>

            <h2 class="section-title">Collection</h2>
            <div class="checkbox-group">
                <input type="checkbox" id="counter-sales">
                <label for="counter-sales">Home Collection</label>
            </div>



            <div class="tests-section">
                <div class="add-test-section">
                    <div class="test-inputs" style="justify-content:end">
                        @*<a href="@Url.Action("Index","CasePaper")" class="add-btn">Save</a>*@
                        <button class="add-btn" id="save">Save</button>
                        @*<button class="add-btn" style="background:red!important">Cancle</button>*@
                        <a class="add-btn" style="background:red!important" href="/CasePaper/index" data-ajax-update="#mainContent" data-ajax-mode="replace" data-ajax-method="GET" data-ajax="true">Cancle</a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">
   $(document).ready(function () {
    $("#save").click(function (e) {
        e.preventDefault(); // Prevents form submission

        console.log("Save button clicked"); // Debugging

        var _ObjCsPaper = {
            PatientName: $("#PName").val(),
            DateOfBirth: $("#PBOD").val(),
            Gender: $("#Gender").val(),
            Contact: $("#PNumber").val(),
            Doctor: $("#Doctor").val()
        };

        $("#mainContent").html('<div></div>');

        $.ajax({
            url: '@Url.Action("Create", "CasePaper")', // Correct MVC URL
            type: "POST",
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify(_ObjCsPaper),
            success: function (response) {
                console.log("Response: ", response, status);
                if (response.Status) {
                    $.smallBox({
                        title: "Save Form",
                        content: "Successfully saved",
                        color: "#C46A69",
                        timeout: 7000,
                    });
                }
                if (response === 0) {
                    $.ajax({
                        url: '@Url.Action("Index", "CasePaper")',
                        type: "GET",
                        success: function (data) {
                            $("#mainContent").html(data);
                        },
                        error: function (err) {
                            console.error("Error loading index: ", err);
                        }
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error: ", status, error);
                alert("Error: " + error);
            }
        });
    });

       $("#btnAdd").click(function () {
           if ($("#hfTestId").val() == 0) {
               alert("Please select proper material.");
               $('#TestName').focus();
               return false;
           }

           var cur_row_num = $('#tblMaterials > tbody > tr').length;

           var TestCode = $("#hfTestId").val();
           var TestName = $("#TestName").val();
           var price = $("#hfPrice").val();
           var labprice = $("#hfLabPrice").val(); // Hidden value

           // Prevent duplicate material
           if (document.getElementById(TestCode)) {
               alert("Duplicate material is not allowed.");
               return;
           }

           var row = `
      <tr id="row${cur_row_num}">
            <td data-editable="false">${cur_row_num}</td>
            <td data-editable="true">${TestName}
                  <input type='hidden' id='MatCode${cur_row_num}' value='${TestCode}'>
                  <input type='hidden' id='${TestCode}' value='${TestCode}'>
                  <input type='hidden' id='LabPrice${cur_row_num}' value='${labprice}'> 
            </td>
            <td data-editable="true" id="Amount${cur_row_num}" name="Amount">${price}</td>
            <td>
                <a class="delete-btn remove-row" href="javascript:void(0);" onclick="removeRow(this)">Delete</a>
            </td>
      </tr>

    //<tr>
    //    <td class="text-center">${cur_row_num}</td>
    //    <td>${mat_name}
    //        <input id='MatCode${cur_row_num}' type='hidden' value='${matcode}'>
    //        <input id='${matcode}' type='hidden' value='${matcode}'>
    //    </td>
    //    <td class="text-center">
    //        <label class="input">
    //            <input class="number text-right input-xs qty-field" id="Qty${cur_row_num}" name="Qty[]" value="0" type="text" min="1" required>
    //            <b class="tooltip tooltip-top-right">
    //                <i class="fa fa-warning txt-color-teal"></i>Input Quantity (must be > 0)
    //            </b>
    //        </label>
    //    </td>
    //    <td class="text-center">
    //        <label class="input">
    //            <input class="number text-right input-xs rate-field" id="Rate${cur_row_num}" name="Rate[]" value="0" type="text" min="1" required>
    //            <b class="tooltip tooltip-top-right">
    //                <i class="fa fa-warning txt-color-teal"></i>Input Rate (must be > 0)
    //            </b>
    //        </label>
    //    </td>
    //    <td class="text-center">
    //        <label class="input">
    //            <input class="number text-right input-xs" id="Amount${cur_row_num}" value="" type="text" disabled="disabled">
    //            <b class="tooltip tooltip-top-right">
    //                <i class="fa fa-warning txt-color-teal"></i>Amount
    //            </b>
    //        </label>
    //    </td>
    //    <td class="text-center">
    //        <a class="btn btn-default remove-row" href="javascript:void(0);" onclick="removeRow(this)">
    //            <i class="fa fa-lg fa-fw fa-minus"></i>
    //        </a>
    //    </td>
    //</tr>
    `;


           $('#tblMaterials > tbody > tr:last').before(row);


           $("#TestName").val('');
           $("#hfMatId").val(0);


           regen_srno();
       });


       $('#tblMaterials').on('click', '.remove-row', function () {
           $(this).closest('tr').remove();
           regen_srno();
           calculateSum();
       });

       $('#tblMaterials').on('input', '.qty-field, .rate-field', function () {
           calculateAmt(this);
       });

       function regen_srno() {
           $('#tblMaterials > tbody > tr').not(':last').each(function (index) {

               $(this).find('td:first').text(index + 1);

               $(this).find('input, label').each(function () {
                   var currentId = $(this).attr('id');
                   if (currentId) {

                       var newId = currentId.replace(/\d+$/, index + 1);
                       $(this).attr('id', newId);
                   }
               });
           });
       }

       function removeRow(button) {
           $(button).closest('tr').remove();
           regen_srno();
           calculateSum();
       }

       function calculateSum() {
           var sum = 0;

           $('#tblMaterials').find("[id*=Amount]").each(function () {
               sum += parseFloat($(this).val()) || 0;
           });
           $('#transaction').val(sum.toFixed(2));
           assignBasicAmount();
       }

       function calculateAmt(obj) {
           var $row = $(obj).closest('tr');
           var NQty = parseFloat($row.find("[id^=Qty]").val()) || 0;
           var NRate = parseFloat($row.find("[id^=Rate]").val()) || 0;

           var Total = NQty * NRate;

           $row.find("[id^=Amount]").val(Total.toFixed(2));

           calculateSum();
       }

       function assignBasicAmount() {
           $('#TaxAmount1').val($('#transaction').val());
           calculate();
       }


       $(function () {
           $('[id*=TestName]').keyup(function () {
               if ($("#TestName").val().trim().length >= 3) {
                   dontBlock = true;
               }
           });

           $('[id*=TestName]').autocomplete({
               minLength: 1,
               source: function (request, response) {
                   $.ajax({
                       url: "/CasePaper/TestAutoFill?searchtext=" + $("#TestName").val(),
                       dataType: "json",
                       type: "POST",
                       contentType: "application/json; charset=utf-8",
                       success: function (data) {
                           dontBlock = false;
                           $("#hfTestId").val(0);
                           $("#hfTestName").val('');
                           $("#hfPrice").val(0);
                           $("#hfLabPrice").val(0);
                           items = [];
                           map = {};

                           $.each(data, function (i, item) {
                               var id = item.TestCode;
                               var name = item.TestName;
                               var price = item.Price;
                               var labprice = item.LabPrice;

                               map[name] = { id: id, name: name, price: price, labprice: labprice };
                               items.push(name);
                           });
                           response(items);
                           $(".dropdown-menu").css("height", "auto");
                       },
                       error: function (response) {
                           dontBlock = false;
                           alert(response.responseText);
                       },
                       failure: function (response) {
                           dontBlock = false;
                           alert(response.responseText);
                       }
                   });
               },
               select: function (event, ui) {
                   $('[id*=hfTestId]').val(map[ui.item.value].id);
                   $('[id*=hfTestName]').val(map[ui.item.value].name);
                   $('[id*=hfPrice]').val(map[ui.item.value].price);
                   $('[id*=hfLabPrice]').val(map[ui.item.value].labprice); // Storing hidden LabPrice
               }
           });


       });
   });

</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("#tblMaterials td[data-editable='true']").forEach(cell => {
            cell.addEventListener("click", function () {
                let currentValue = this.textContent.trim();

                // Prevent duplicate input elements
                if (this.querySelector("input")) return;

                let input = document.createElement("input");
                input.type = "text";
                input.value = currentValue;
                this.innerHTML = "";
                this.appendChild(input);
                input.focus();

                // On losing focus, save and revert to text
                input.addEventListener("blur", function () {
                    cell.textContent = this.value.trim();
                });

                // Save on pressing Enter
                input.addEventListener("keypress", function (event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        input.blur();
                    }
                });
            });
        });
    });
</script>